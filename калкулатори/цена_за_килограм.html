<!DOCTYPE html>
<html lang="bg">

<head>
	<meta charset="utf-8">
	<title>–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä: –¶–µ–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º (–∏–ª–∏ –ª–∏—Ç—ä—Ä) (–∏–∑—á–∏—Å—Ç–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç @bosadjo)</title>
	<style>
		label {
			display: block;
		}

		input[type=text],
		input[type=number] {
			width: 9ch;
		}

		input:read-only {
			background: lightgreen;
		}

		p {
			margin: auto;
		}

		table {
			margin-left: auto;
			margin-right: auto;
			border-collapse: collapse;
		}

		td,
		th {
			border: 1px solid gray;
		}

		* {
			font-size: 23px;
		}

		body {
			/* Firefox doesn't support zoom property */
			/* zoom: 150%; */
			display: flex;
			text-align: center;
			justify-content: center;
		}
	</style>
	<style id="dark-theme">
		* {
			background-color: black;
			color: white;
		}

		input:read-only {
			background: green;
		}
	</style>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
	<fieldset>
		<legend>–ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä: –¶–µ–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º (–∏–ª–∏ –ª–∏—Ç—ä—Ä)</legend>
		<button id="themeButton" onclick="toggleLightDarkTheme()" title="Toggle Light/Dark Theme"></button>
		<label>–†–µ–∂–∏–º:
			<select id="modeSelect" onchange="toggleMode(this.value)">
				<option value="automatic">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω</option>
				<option value="manual">–†—ä—á–µ–Ω</option>
			</select>
		</label>
		<!-- –∏–∑–≤–µ—Å—Ç–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ -->
		<p id="infoText" style="font-size: small;">
			–í—ä–≤–µ–¥–µ—Ç–µ –¥–≤–µ –ø—Ä–æ–∏–∑–≤–æ–ª–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏,<br>
			—Ç—Ä–µ—Ç–∞—Ç–∞ —â–µ —Å–µ –∏–∑—á–∏—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.<br>
		</p>
		<br>
		<!-- <div style="font-size: small;" onchange="changeMode()">
			<label style="display: inline;">–†—ä—á–Ω–æ
				<input type="radio" name="mode" value="manual">
			</label>
			<label style="display: inline;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
				<input type="radio" name="mode" value="auto" checked>
			</label>
		</div> -->
		<!-- <button>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öô</button>
	<br> -->
		<div id="mainEverything" oninput="calculatePricePerWeight()">
			<label>–¶–µ–Ω–∞:
				<input step=".01" type="number" id="price" placeholder="0.00" autofocus>
				<select id="currencySelect" onchange="changeCurrency(this.value)">
					<option value="EUR">‚Ç¨</option>
					<option value="BGN">–ª–≤</option>
				</select>
			</label>
			<br>
			<label>–¢–µ–≥–ª–æ:
				<input step="1" type="number" id="weight" placeholder="0">
				<select oninput="unitChangeInputStep(this.value)" id="weightUnit" tabindex="-1">
					<option value="1000">–≥—Ä</option>
					<option value="1">–∫–≥</option>
				</select>
			</label>
			<br>
			<label>–¶–µ–Ω–∞ –∑–∞ –∫–≥:
				<input step=".01" type="number" id="pricePerKG" placeholder="0.00"> <span id="unitLabel">‚Ç¨/–∫–≥</span>
			</label>
			<br>
			<button id="calcButton" style="display: none;" onclick="calculatePricePerWeight()">–ò–∑—á–∏—Å–ª–∏</button>
			<br>
			<button onclick="clearInputs()" tabindex="-1">üóëÔ∏è –ù–æ–≤–æ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ</button>
			<p style="font-size: small;">–ö–ª–∞–≤–∏—à [–∏–Ω—Ç–µ—Ä–≤–∞–ª] –∑–∞ –Ω–æ–≤–æ –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ.</p>
			<hr>
			<label>–ò–º–µ:
				<input type="text" id="itemName" placeholder="–ò–º–µ">
			</label>
			(–Ω–µ–∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ, –∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
		</div>
		<br>
		<button onclick="saveItem()">üíæ –ó–∞–ø–∞–∑–∏ –∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
		<br>
		<br>
		<div id="items"></div>
		<br>
		<button onclick="editTable(this)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ</button>
		<br>
		<button onclick="deleteItems()">–ò–∑—Ç—Ä–∏–π –∑–∞–ø–∏—Å–∏</button>
		<br>
		<button onclick="elementToggle(formulas)">–§–æ—Ä–º—É–ª–∏</button>
		<div id="formulas" style="display: none;">
			<img src="pricePerWeight.svg" alt="formulas triangle" />
			<br>
			–¶–µ–Ω–∞ = –¢–µ–≥–ª–æ * –¶–µ–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º (<span id="formulasUnit">‚Ç¨/–∫–≥</span>)<br>
			–¢–µ–≥–ª–æ = –¶–µ–Ω–∞ / –¶–µ–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º (<span id="formulasUnit2">‚Ç¨/–∫–≥</span>)<br>
			–¶–µ–Ω–∞ –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º (<span id="formulasUnit3">‚Ç¨/–∫–≥</span>) = –¶–µ–Ω–∞ / –¢–µ–≥–ª–æ<br>
		</div>
		<br>
		<p><a href="mailto:bosadjo@proton.me">–ö–æ–Ω—Ç–∞–∫—Ç: bosadjo@proton.me</a></p>	
	</fieldset>
	<script>
		var price = document.getElementById('price')
		var weight = document.getElementById('weight')
		var weightUnit = document.getElementById('weightUnit')
		var pricePerKG = document.getElementById('pricePerKG')
		var currencySelect = document.getElementById('currencySelect')
		var unitLabel = document.getElementById('unitLabel')
		var formulasUnit = document.getElementById('formulasUnit')
		var formulasUnit2 = document.getElementById('formulasUnit2')
		var formulasUnit3 = document.getElementById('formulasUnit3')
		const EUR_TO_BGN = 1.95583
		// current currency will be either 'EUR' or 'BGN'
		function changeCurrency(newCurrency) {
			let oldCurrency = localStorage.getItem('currency') || 'EUR'
			if (newCurrency === oldCurrency) {
				localStorage.setItem('currency', newCurrency)
				updateUnitLabels(newCurrency)
				loadItems()
				return
			}
			// convert inputs if they have values
			if (price.value !== '') {
				if (newCurrency === 'BGN' && oldCurrency === 'EUR') price.value = (price.value * EUR_TO_BGN).toFixed(2)
				if (newCurrency === 'EUR' && oldCurrency === 'BGN') price.value = (price.value / EUR_TO_BGN).toFixed(2)
			}
			if (pricePerKG.value !== '') {
				if (newCurrency === 'BGN' && oldCurrency === 'EUR') pricePerKG.value = (pricePerKG.value * EUR_TO_BGN).toFixed(2)
				if (newCurrency === 'EUR' && oldCurrency === 'BGN') pricePerKG.value = (pricePerKG.value / EUR_TO_BGN).toFixed(2)
			}
			localStorage.setItem('currency', newCurrency)
			updateUnitLabels(newCurrency)
			loadItems()
		}
		function updateUnitLabels(curr) {
			let unit = curr === 'EUR' ? '‚Ç¨/–∫–≥' : '–ª–≤/–∫–≥'
			unitLabel.textContent = unit
			formulasUnit.textContent = unit
			formulasUnit2.textContent = unit
			formulasUnit3.textContent = unit
		}
		function toggleMode(mode) {
			//if (document.querySelector('input[name=mode]:checked').value === 'manual') {
			if (mode == 'manual') {
				// manual mode setting
				mainEverything.oninput = null
				calcButton.style.display = 'inline-block'
				infoText.style.display = 'none'
			} else if (mode == 'automatic') {
				// enabling automatic mode
				mainEverything.oninput = calculatePricePerWeight
				calcButton.style.display = 'none'
				infoText.style.display = 'block'
				calculatePricePerWeight()
			}
		}
		function unitChangeInputStep(unit) {
			if (unit === '1') {
				weight.step = 0.001
				if (weight.value !== '') {
					weight.value /= 1000
				}
			} else if (unit === '1000') {
				weight.step = 1
				if (weight.value !== '') {
					weight.value *= 1000
				}
			}
			// if (weight.value !== '') {
			//   weight.value /= weightUnit.querySelector(':not(:checked)').value
			// }
		}
		function calculatePricePerWeight() {
			// –º–æ–∂–µ –¥–∞ –∏–º–∞ 1 —Å—Ç–æ—Ç–∏–Ω–∫–∞ –∏–ª–∏ 1 –≥—Ä–∞–º —Ä–∞–∑–ª–∏–∫–∞ –æ—Ç —Ç–∞–∑–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç –æ—Ç —Ç–æ–≤–∞ –∫–∞–∫ –∑–∞–∫—Ä—ä–≥–ª—è—Ç
			if (price.value !== '' && weight.value !== '' && !price.readOnly && !weight.readOnly) {
				pricePerKG.value = (Math.ceil(+(price.value / (weight.value / weightUnit.value)) * 100) / 100).toFixed(2)
				pricePerKG.readOnly = true
			} else if (weight.value !== '' && pricePerKG.value !== '' && !weight.readOnly && !pricePerKG.readOnly) {
				price.value = ((weight.value / weightUnit.value) * pricePerKG.value).toFixed(2)
				price.readOnly = true
			} else if (price.value !== '' && pricePerKG.value !== '' && !price.readOnly && !pricePerKG.readOnly) {
				if (weightUnit.value === '1000') {
					weight.value = Math.ceil((price.value / pricePerKG.value) * 1000)
				} else {
					weight.value = Math.ceil((price.value / pricePerKG.value) * 1000) / 1000
				}
				weight.readOnly = true
			}
		}
		// if key doesn't exist
		if (localStorage.getItem('priceItems') === null) {
			localStorage.setItem('priceItems', JSON.stringify([]))
		}

		document.querySelectorAll('input[type=number]').forEach(input => {
			input.onbeforeinput = function (event) {
				if (event.data == " ") {
					clearInputs()
					event.preventDefault()
				}
			}
		})

		function clearInputs() {
			document.querySelectorAll('input[type=number],input[type=text]').forEach(input => {
				input.value = ''
				input.readOnly = false
			})
		}

		function saveItem() {
			if (pricePerKG.value === '') {
				return
			}
			let items = JSON.parse(localStorage.getItem('priceItems'))
			let suffix = (localStorage.getItem('currency') || 'EUR') === 'EUR' ? ' ‚Ç¨/–∫–≥' : ' –ª–≤/–∫–≥'
			items.push([itemName.value, pricePerKG.value + suffix])
			localStorage.setItem('priceItems', JSON.stringify(items))
			loadItems()
		}
		function deleteItems() {
			let items = JSON.parse(localStorage.getItem('priceItems'))
			let newItems = []
			document.querySelectorAll('input[type=checkbox][name=item]:not(:checked)').forEach(element => {
				newItems.push(items[element.value])
			});
			localStorage.setItem('priceItems', JSON.stringify(newItems))
			loadItems()
		}
		function toggleCheckboxes(source) {
			var checkboxes = document.getElementsByName('item');
			for (var checkbox of checkboxes)
				checkbox.checked = source.checked;
		}
		function checkCheckboxes() {
			let allChecked = true
			document.getElementsByName('item').forEach(element => {
				if (!element.checked) {
					allChecked = false
				}
			})
			mainCheckbox.checked = allChecked
		}
		function loadItems() {
			let curr = localStorage.getItem('currency') || 'EUR'
			let unitSuffix = curr === 'EUR' ? '‚Ç¨/–∫–≥' : '–ª–≤/–∫–≥'
			var text = `<table id="tableWithItems"><tr><th><input id="mainCheckbox" type="checkbox" onclick="toggleCheckboxes(this)"></th><th>–ò–º–µ</th><th>${unitSuffix}</th></tr>`
			let items = JSON.parse(localStorage.getItem('priceItems'))
			for (var i = 0; i < items.length; i++) {
				text += `<tr><td><input type="checkbox" onclick="checkCheckboxes()" name="item" value=${i}></td>`
				for (let j = 0; j < items[i].length; j++) {
					let cell = items[i][j]
					if (j === 1) {
						// parse existing stored value and convert to current currency if needed
						let stored = String(cell)
						let storedCurrency = stored.includes('–ª–≤') ? 'BGN' : (stored.includes('‚Ç¨') ? 'EUR' : 'BGN')
						let num = parseFloat(stored.replace(',', '.').match(/[-\d\.]+/))
						if (!isNaN(num)) {
							if (storedCurrency === 'BGN' && curr === 'EUR') num = num / EUR_TO_BGN
							if (storedCurrency === 'EUR' && curr === 'BGN') num = num * EUR_TO_BGN
							cell = num.toFixed(2) + ' ' + unitSuffix
						}
					}
					text += '<td>' + cell + '</td>'
				}
				text += '</tr>'
			}
			document.getElementById('items').innerHTML = text + '</table>'
		}
		loadItems()
		function deleteAllItems() {
			localStorage.setItem('priceItems', JSON.stringify([]))
		}
		function HTMLTableTo2DJSArray(table, ignoreRowsCount = 0, ignoreColsCount = 0) {
			let rows = table.querySelector('tbody').querySelectorAll('tr')
			let arr = []
			for (let i = 0 + ignoreRowsCount; i < rows.length; i++) {
				arr.push([])
				let cols = rows[i].querySelectorAll('td')
				for (let j = 0 + ignoreColsCount; j < cols.length; j++) {
					arr[i - ignoreRowsCount].push(cols[j].textContent)
				}
			}
			// Verification
			// console.log('Is parsed array equal existing array? ' + (JSON.stringify(arr) === localStorage.getItem('priceItems')))
			return arr
		}
		function editTable(button) {
			if (tableWithItems.isContentEditable) {
				tableWithItems.contentEditable = false
				button.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ'
				localStorage.setItem('priceItems', JSON.stringify(HTMLTableTo2DJSArray(tableWithItems, 1, 1)))
				loadItems()
			} else {
				tableWithItems.contentEditable = true
				button.textContent = '‚úèÔ∏èüíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ'
			}
		}

		function elementToggle(el) {
			if (el.style.display === "none") {
				el.style.display = "block";
			} else {
				el.style.display = "none";
			}
		}
		
		var themeText = document.getElementById("themeButton")
		function applyTheme() {
			if (localStorage.getItem('theme') === 'dark') {
				document.getElementById('dark-theme').disabled = false
				themeText.textContent = "–°–≤–µ—Ç–ª–∞ —Ç–µ–º–∞"
			} else {
				document.getElementById('dark-theme').disabled = true
				themeText.textContent = "–¢—ä–º–Ω–∞ —Ç–µ–º–∞"
			}
		}
		if (localStorage.getItem('theme') === null) {
			localStorage.setItem('theme', 'dark')
		}
		applyTheme()
		// initialize currency (default EUR)
		var initialCurrency = localStorage.getItem('currency') || 'EUR'
		currencySelect.value = initialCurrency
		updateUnitLabels(initialCurrency)
		localStorage.setItem('currency', initialCurrency)
		function toggleLightDarkTheme() {
			if (localStorage.getItem('theme') === 'dark') {
				localStorage.setItem('theme', 'light')
			} else {
				localStorage.setItem('theme', 'dark')
			}
			applyTheme()
		}
	</script>
</body>

</html>
